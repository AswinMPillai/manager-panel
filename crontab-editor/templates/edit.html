{% extends "base.html" %}

{% block content %}
<a href="{{ url_for('index') }}" class="back-link">&laquo; Back to Users</a>

<h2>Edit Crontab for {{ username }}</h2>

<div class="tabs">
    <button class="tab-button active" onclick="openTab(event, 'tabAdd')">Add/Edit Cron Job</button>
    <button class="tab-button" onclick="openTab(event, 'tabDirect')">Direct Edit</button>
</div>

<div id="tabAdd" class="tab-content" style="display: block;">
    <div class="cron-builder-container">
        <form method="POST" action="{{ url_for('edit_crontab', username=username) }}" id="cron-form">
            <input type="hidden" id="edit_mode" name="edit_mode" value="add">
            <input type="hidden" id="original_minute" name="original_minute">
            <input type="hidden" id="original_hour" name="original_hour">
            <input type="hidden" id="original_day" name="original_day">
            <input type="hidden" id="original_month" name="original_month">
            <input type="hidden" id="original_weekday" name="original_weekday">
            <input type="hidden" id="original_command" name="original_command">

            <div class="form-row">
                <div class="form-group">
                    <label for="minute">Minute:</label>
                    <input type="text" id="minute" name="minute" class="form-control" value="*">
                    <select class="form-control" onchange="updateField('minute', this.value)">
                        <option>-- Common Settings --</option>
                        <option value="*">Every Minute (*)</option>
                        <option value="*/2">Every 2 Minutes (*/2)</option>
                        <option value="*/5">Every 5 Minutes (*/5)</option>
                        <option value="*/15">Every 15 Minutes (*/15)</option>
                        <option value="*/30">Every 30 Minutes (*/30)</option>
                        <option value="0">At the Hour (0)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="hour">Hour:</label>
                    <input type="text" id="hour" name="hour" class="form-control" value="*">
                    <select class="form-control" onchange="updateField('hour', this.value)">
                        <option>-- Common Settings --</option>
                        <option value="*">Every Hour (*)</option>
                        <option value="*/2">Every 2 Hours (*/2)</option>
                        <option value="*/4">Every 4 Hours (*/4)</option>
                        <option value="*/6">Every 6 Hours (*/6)</option>
                        <option value="0">Midnight (0)</option>
                        <option value="12">Noon (12)</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="day">Day:</label>
                    <input type="text" id="day" name="day" class="form-control" value="*">
                    <select class="form-control" onchange="updateField('day', this.value)">
                        <option>-- Common Settings --</option>
                        <option value="*">Every Day (*)</option>
                        <option value="*/2">Every Other Day (*/2)</option>
                        <option value="1">1st of Month (1)</option>
                        <option value="15">15th of Month (15)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="month">Month:</label>
                    <input type="text" id="month" name="month" class="form-control" value="*">
                    <select class="form-control" onchange="updateField('month', this.value)">
                        <option>-- Common Settings --</option>
                        <option value="*">Every Month (*)</option>
                        <option value="*/3">Every Quarter (*/3)</option>
                        <option value="*/6">Every 6 Months (*/6)</option>
                        <option value="1">January (1)</option>
                        <option value="6">June (6)</option>
                        <option value="12">December (12)</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="weekday">Weekday:</label>
                    <input type="text" id="weekday" name="weekday" class="form-control" value="*">
                    <select class="form-control" onchange="updateField('weekday', this.value)">
                        <option>-- Common Settings --</option>
                        <option value="*">Every Day (*)</option>
                        <option value="1-5">Weekdays (1-5)</option>
                        <option value="0,6">Weekends (0,6)</option>
                        <option value="1">Monday (1)</option>
                        <option value="5">Friday (5)</option>
                    </select>
                </div>
            </div>

            <div class="form-section">
                <label for="command">Command:</label>
                <input type="text" id="command" name="command" class="form-control" value="">
            </div>

            <div class="form-section">
                <h3>Example:</h3>
                <pre>/usr/bin/php /home/username/laravel-app/artisan schedule:run</pre>
            </div>

            <div class="form-section">
                <button type="submit" id="submit-button" class="button">Add New Cron Job</button>
                <button type="button" id="cancel-button" class="button" style="background-color: #6c757d; display: none;" onclick="cancelEdit()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div id="tabDirect" class="tab-content">
    <form method="POST" action="{{ url_for('edit_crontab', username=username) }}">
        <div class="form-section">
            <label for="crontab_content">Direct Edit:</label>
            <textarea id="crontab_content" name="crontab_content" rows="10">{{ crontab_content }}</textarea>
        </div>
        <div class="form-section">
            <button type="submit" class="button">Save Changes</button>
        </div>
    </form>
</div>

<h2>Current Cron Jobs</h2>
<div class="cron-jobs-table">
    <table class="user-table">
        <thead>
            <tr>
                <th>Minute</th>
                <th>Hour</th>
                <th>Day</th>
                <th>Month</th>
                <th>Weekday</th>
                <th>Command</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="cron-jobs-list">
            {% for job in cron_jobs %}
            <tr data-id="{{ loop.index }}">
                <td>{{ job.minute }}</td>
                <td>{{ job.hour }}</td>
                <td>{{ job.day }}</td>
                <td>{{ job.month }}</td>
                <td>{{ job.weekday }}</td>
                <td class="command-cell">{{ job.command }}</td>
                <td>
                    <button class="button small" onclick="editJob({{ loop.index }})">Edit</button>
                    <button class="button small" style="background-color: #dc3545;" onclick="deleteJob({{ loop.index }})">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tab-button");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    function updateField(field, value) {
        if (value !== "-- Common Settings --") {
            document.getElementById(field).value = value;
        }
    }

    function editJob(id) {
        const row = document.querySelector(`tr[data-id="${id}"]`);
        const minute = row.cells[0].innerText;
        const hour = row.cells[1].innerText;
        const day = row.cells[2].innerText;
        const month = row.cells[3].innerText;
        const weekday = row.cells[4].innerText;
        const command = row.cells[5].innerText;

        document.getElementById("minute").value = minute;
        document.getElementById("hour").value = hour;
        document.getElementById("day").value = day;
        document.getElementById("month").value = month;
        document.getElementById("weekday").value = weekday;
        document.getElementById("command").value = command;

        // Set original values for update
        document.getElementById("original_minute").value = minute;
        document.getElementById("original_hour").value = hour;
        document.getElementById("original_day").value = day;
        document.getElementById("original_month").value = month;
        document.getElementById("original_weekday").value = weekday;
        document.getElementById("original_command").value = command;

        // Change form to edit mode
        document.getElementById("edit_mode").value = "edit";
        document.getElementById("submit-button").textContent = "Update Cron Job";
        document.getElementById("cancel-button").style.display = "inline-block";

        // Scroll to the top of the form
        document.querySelector(".cron-builder-container").scrollIntoView();

        // Switch to the Add tab
        document.querySelector(".tab-button").click();
    }

    function cancelEdit() {
        // Reset form to add mode
        document.getElementById("edit_mode").value = "add";
        document.getElementById("submit-button").textContent = "Add New Cron Job";
        document.getElementById("cancel-button").style.display = "none";

        // Clear form fields
        document.getElementById("minute").value = "*";
        document.getElementById("hour").value = "*";
        document.getElementById("day").value = "*";
        document.getElementById("month").value = "*";
        document.getElementById("weekday").value = "*";
        document.getElementById("command").value = "";

        // Clear original values
        document.getElementById("original_minute").value = "";
        document.getElementById("original_hour").value = "";
        document.getElementById("original_day").value = "";
        document.getElementById("original_month").value = "";
        document.getElementById("original_weekday").value = "";
        document.getElementById("original_command").value = "";
    }

    function deleteJob(id) {
        if (confirm("Are you sure you want to delete this cron job?")) {
            // Get the row data
            const row = document.querySelector(`tr[data-id="${id}"]`);
            const minute = row.cells[0].innerText;
            const hour = row.cells[1].innerText;
            const day = row.cells[2].innerText;
            const month = row.cells[3].innerText;
            const weekday = row.cells[4].innerText;
            const command = row.cells[5].innerText;

            // Create a form to submit the delete request
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("delete_cron", username=username) }}';

            const minuteInput = document.createElement('input');
            minuteInput.type = 'hidden';
            minuteInput.name = 'minute';
            minuteInput.value = minute;
            form.appendChild(minuteInput);

            const hourInput = document.createElement('input');
            hourInput.type = 'hidden';
            hourInput.name = 'hour';
            hourInput.value = hour;
            form.appendChild(hourInput);

            const dayInput = document.createElement('input');
            dayInput.type = 'hidden';
            dayInput.name = 'day';
            dayInput.value = day;
            form.appendChild(dayInput);

            const monthInput = document.createElement('input');
            monthInput.type = 'hidden';
            monthInput.name = 'month';
            monthInput.value = month;
            form.appendChild(monthInput);

            const weekdayInput = document.createElement('input');
            weekdayInput.type = 'hidden';
            weekdayInput.name = 'weekday';
            weekdayInput.value = weekday;
            form.appendChild(weekdayInput);

            const commandInput = document.createElement('input');
            commandInput.type = 'hidden';
            commandInput.name = 'command';
            commandInput.value = command;
            form.appendChild(commandInput);

            document.body.appendChild(form);
            form.submit();
        }
    }
</script>
{% endblock %}
